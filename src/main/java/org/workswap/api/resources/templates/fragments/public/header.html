<div class="header-container" th:fragment="header">
    <nav class="navbar">
        <a class="navbar-brand" href="/catalog" th:text="#{brand}">WorkSwap</a>
        <div class="flex-row media-only-flex">
            <div class="nav-link">
                <label th:replace="~{fragments/theme-changer :: themeChanger}"></label>
            </div>
            <button class="navbar-toggler">
                <span class="navbar-toggler-icon"></span>
            </button>
        </div>
        <div class="navbar-collapse">
            <nav class="navbar-top">
                <a class="navbar-brand" href="/catalog" th:text="#{brand}">WorkSwap</a>
                <button id="navbar-toggler" class="navbar-toggler">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </nav>

            <div th:replace="~{fragments/public/header :: navButtons}"></div>

            <div class="account-manager">
                <div th:replace="~{fragments/account/account-sidebar :: sidebarLinks}"></div>
            </div>
        </div>
    </nav>
    <script th:inline="javascript" defer>
        document.addEventListener('DOMContentLoaded', () => {
            const notificationBtn = document.getElementById('notificationBtn');
            const dropdown = document.getElementById('notificationDropdown');
            const list = document.getElementById('notificationList');

            notificationBtn.addEventListener('click', () => {
                dropdown.classList.toggle('visible');

                const userId = /*[[${user != null ? user.id : ''}]]*/ '';

                /* if (!userId) return; */

                fetch(`/api/notifications/for-user/${userId}`)
                    .then(response => {
                        if (!response.ok) throw new Error("Ошибка при загрузке уведомлений");
                        return response.json(); // Предполагается, что сервер возвращает JSON
                    })
                    .then(notifications => {
                        console.log(notifications)
                        list.innerHTML = '';
                        if (notifications.length === 0) {
                            list.innerHTML = '<p class="no-notifications">Нет уведомлений</p>';
                        } else {
                            notifications.forEach(n => {
                                const item = document.createElement('a');
                                item.href = n.link || '#';
                                item.className = `notification-center-item ${n.importance.toLowerCase()}`;
                                item.innerHTML = `
                                    <div class="notification-content">
                                        <strong>${n.title}</strong><br>
                                        <span>${n.content}</span>
                                    </div>
                                `;
                                list.appendChild(item);
                            });
                        }
                        list.dataset.loaded = 'true';
                    })
                    .catch(err => {
                        console.error(err);
                        list.innerHTML = '<p class="no-notifications">Ошибка загрузки</p>';
                    });
            });

            // Закрытие окна при клике вне
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target) && !notificationBtn.contains(e.target)) {
                    dropdown.classList.remove('visible');
                }
            });
        });
    </script>
    <script src="/js/components/theme-changer.js"></script>
</div>

<div class="nav-buttons" th:fragment="navButtons">
    <div class="flex-row">
        <div class="nav-link normal-only">
            <label th:replace="~{fragments/theme-changer :: themeChanger}"></label>
        </div>
        
        <a href="/secure/messenger/chat?sellerId=71" class="nav-link" th:if="${isAuthenticated}">
            <i class="fa fa-question-circle fa-lg" aria-hidden="true"></i>
        </a>

        <button class="nav-link" id="notificationBtn" th:if="${isAuthenticated}">
            <i class="fa fa-bell fa-lg" aria-hidden="true"></i>
        </button>

        <!-- Выпадающее окно с уведомлениями -->
        <div id="notificationDropdown" class="notification-center-dropdown hidden">
            <div class="notification-center-header">Уведомления</div>
            <div id="notificationList" class="notification-center-list">
                <p class="no-notifications">Загрузка...</p>
            </div>
        </div>

        <a th:if="${roleAdmin}" href="https://dash.workswap.org" class="nav-link" th:text="#{header.admin}">Админка</a>
        <!-- Кнопка Новостей -->
        <a href="/news" class="nav-link" th:text="#{header.news}">Новости</a>
    </div>

    <!-- Для неавторизованных пользователей -->
    <a href="/login" style="display: flex; flex-direction: row" class="btn btn-outline-primary" th:unless="${isAuthenticated}">
        <img src="/images/google.png" class="logo">
        <span th:text="#{header.login}">Войти через Google</span>
    </a>

    <!-- Для авторизованных пользователей -->
    <div th:if="${isAuthenticated}" th:href="@{/secure/account}" class="account-link-container">
        <a th:href="@{/secure/account}" class="account-link">
            <img th:replace="~{fragments/small-components :: avatar(user=${user}, size='32', class='')}"></img>
            <span th:text="${user.name}" class="ellipsis">Пользователь</span>
        </a>
        <a href="#" class="logout-btn" onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">
            <i class="fa fa-sign-out fa-lg" aria-hidden="true" style="transform: rotate(180deg);"></i>
        </a>
    </div>

    <form id="logoutForm" action="/logout" method="post" style="display:none;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    </form>
</div>  