<!-- карточка объявления для показа на публичных страницах (с рейтингом, локацией) -->
<article th:each="listing : ${listings}" 
         class="listing-card hover-animation-card" 
         th:fragment="listingCard(listings)" 
         th:onclick="window.location.href = '/listing/' + [[${listing.id}]]"
         th:if="${(user != null and user.role != null and user.role.name() == 'ADMIN') or !listing.testMode}"
         th:unless="${mainListingId == listing.id}">
    <img th:src="@{${listing.imagePath}}"
            class="listing-img" th:onerror="this.src='/images/default-listing.png'"
            alt="Изображение объявления">

    <div class="listing-card-body">
        <h3 class="listing-card-title" th:text="${listing.localizedTitle}">Название</h3>
        <p class="listing-card-text" th:text="${#strings.length(listing.localizedDescription) > 100} ? ${#strings.substring(listing.localizedDescription, 0, 100)} + '...' : ${listing.localizedDescription}">Описание</p>
        <div class="listing-card-footer">
            <div>
                <!-- компонент для отображение цены (с типом) -->
                <span th:replace="~{fragments/small-components :: priceTypes}"></span>
                <div th:replace="~{fragments/small-components :: listingRating}"></div>
            </div>
            <span class="partner-sign" th:if="${listing.author.role.name() == 'BUSINESS'}" th:text="#{partner}"></span>
            <span class="listing-location" th:text="${listing.location.fullName}">Локация</span>
        </div>
    </div>
</article>

<!-- карточка объявления для показа на страницах личного кабинета (с просмотрами и кнопками) -->
<article th:each="listing : ${listings}" class="listing-card hover-animation-card" th:fragment="listingCardAccount" 
            th:onclick="window.location.href = '/listing/' + [[${listing.id}]]">
    <div th:class="${listing.active} ? 'listing-status active' : 'listing-status inactive'"
            th:text="${listing.active} ? 'Активно' : 'Не активно'"></div>

    <img th:src="@{${listing.imagePath}}"
            th:onerror="this.src='/images/default-listing.png'"
            class="listing-img"
            alt="Изображение объявления">

    <div class="listing-card-body">
        <h3 class="listing-card-title" th:text="${listing.localizedTitle}">Название</h3>
        <p class="listing-card-text" th:text="${#strings.abbreviate(listing.localizedDescription, 100)}">Описание</p>
        <div class="listing-card-footer">
            <div>
                <!-- компонент для отображение цены (с типом) -->
                <span th:replace="~{fragments/small-components :: priceTypes}"></span>
                <div class="listing-views">
                    <span th:text="#{listings.views}">0</span>
                    <span th:text="${listing.views}">0</span>
                </div>
            </div>
        </div>
        <!-- кнопки только в "моих объявлениях" -->
        <div class="listing-actions" th:if="${activePage == 'my-listings'}">
            <a th:href="@{/secure/listing/edit/{id}(id=${listing.id})}"
                class="btn btn-sm btn-outline-primary" th:text="#{listing.edit}"></a>
            <form th:action="@{/listing/{id}/delete(id=${listing.id})}"
                    method="post"
                    style="display: inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-sm btn-outline-danger" th:text="#{my.listings.button.delete}" onclick="return confirm('Удалить это объявление?');"></button>
            </form>
        </div>
        <!-- кнопки только в "избранных" -->
        <div class="listing-actions" th:if="${activePage == 'favorites'}">
            <form th:action="@{/listing/{id}/favorite(id=${listing.id})}" method="post" style="display: inline;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button type="submit" class="btn btn-sm btn-outline-danger" th:text="#{listing.favorite.remove}">Убрать из избранных</button>
            </form>
        </div>
    </div>
</article>

<article th:each="listing : ${listings}" class="listing-small-card" th:fragment="listingSmallCardAccount">
    <div class="listing-small-card-body">
        <h3 class="listing-small-card-title" th:text="${listing.localizedTitle}">Название</h3>
        <div class="listing-small-card-stat-body flex-column">
            <div class="flex-row" style="gap: 1rem;">
                <div class="listing-small-card-stat-body-item flex-row" id="views" th:attr="listingId=${listing.id}">
                    <i class="fa-solid fa-eye" style="font-size: x-large;"></i>
                    <span th:text="${listingStats[listing.id]['views']}">1</span>
                </div>
                <div class="listing-small-card-stat-body-item flex-row" id="favorites" th:attr="listingId=${listing.id}">
                    <i class="fa-solid fa-heart" style="font-size: x-large;"></i>
                    <span th:text="${listingStats[listing.id]['favorites']}">1</span>
                </div>
            </div>
            <p th:id="'monthly-views-' + ${listing.id}">Просмотры за последний месяц</p>
            <p th:id="'monthly-favorites-' + ${listing.id}">В избранных за последний месяц</p>
            <button id="stats" class="listing-stats-btn" th:attr="listingId=${listing.id}" onclick="return controlStats(this)">
                <i class="fa-solid fa-square-poll-vertical fa-2x"></i>
            </button>
        </div>
        <div class="stat-panel-card" th:id="'statPanelCard' + ${listing.id}">
            <div class="card">
                <div class="card-body" style="padding: 0.5rem;">
                    <div class="card-header">
                        <h3 th:text="${listing.localizedTitle}"></h3>
                    </div>
                    <div class="stat-actions">
                        <input hidden th:value="${listing.id}" id="listingId">
                        <select name="interval" id="interval" class="interval">
                            <option th:each="type : ${intervalTypes}"
                                    th:value="${type}"
                                    th:text="${type}">
                            </option>
                        </select>
                        <select name="days" id="daysSelect" class="days-select">
                            <option value="1">1 день</option>
                            <option value="3">3 дня</option>
                            <option value="7">7 дней</option>
                            <option value="15">15 дней</option>
                            <option value="30">30 дней</option>
                        </select>
                    </div>
                    <canvas th:id="'statsChart' + ${listing.id}"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- Подключаем Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/js/components/statistic-grath.js"></script>
</article>

<article th:fragment="listingCardPreview" class="listing-card">
    <img th:src="@{${listing != null ? listing.imagePath : null}}"
        class="listing-img" 
        th:onerror="this.src='/images/default-listing.png'"
        alt="Текущее основное изображение"
        id="mainImagePreview">

    <div class="listing-card-body">
        <h3 class="listing-card-title" id="listingCardLabel" th:text="${listing != null ? listing.localizedTitle : null}">Название</h3>
        <p class="listing-card-text" id="listingCardDesc" th:text="${listing != null ? listing.localizedDescription : ''}">Описание</p>
        <div class="listing-card-footer">
            <div>
                <!-- компонент для отображение цены (с типом) -->
                <span th:replace="~{fragments/small-components :: priceTypes}"></span>
                <div th:replace="~{fragments/small-components :: listingRating}"></div>
            </div>
            <span class="partner-sign" th:if="${user.role.name() == 'BUSINESS'}" th:text="#{partner}"></span>
            <span class="listing-location" th:text="${listing != null ? listing.location.fullName : null}">Локация</span>
        </div>
    </div>
</article>